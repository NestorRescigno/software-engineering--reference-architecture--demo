name: Deploy to Dev

on:
  workflow_dispatch:
    inputs:
      ami_version:
        description: 'Version'
        required: true  

jobs:
  deploy:
    name: Deploy
    runs-on: [self-hosted, ancillaries, deploy]
    steps:
    - name: Deploy with Terraform
      uses: ./.github/cicd-ancillaries/github_actions/cd/int/deploy/deploy_terraform

    - name: Health Check
      uses: ./.github/cicd-ancillaries/github_actions/cd/int/deploy/health_check
  integration_tests:
    name: Integration Tests
    needs: [deploy]
    runs-on: [self-hosted, ancillaries, int]
    steps:
    - name: Checkout actions
      uses: actions/checkout@v2
      with:
        repository: 'Iberia-Ent/commercial--management--ancillaries--workflows'
        token: ${{ secrets.GH_PAT_CICD_ANCILLARIES }}
        ref: '1.0'
        path: '.github/cicd-ancillaries'
    
    - name: Checkout tests
      uses: actions/checkout@v2
      with:
        repository: 'Iberia-Ent/commercial--management--ancillaries--anc-ins--tests'
        token: ${{ secrets.GH_PAT_CICD_ANCILLARIES }}
        ref: 'main'
        path: '.github/integration-tests'
    
    - name: Testing
      uses: ./.github/cicd-ancillaries/github_actions/cd/int/deploy/integration_tests
